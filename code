import pandas as pd
from openpyxl import load_workbook

# Função para copiar a coluna "External reference number" da Tabela3 para Tabela1 na planilha "INC MARS"
def copy_external_reference_number(source_file, target_file):
    # Carregar Tabela3 (snow.xlsx)
    df_snow = pd.read_excel(source_file)
   
    # Carregar Tabela1 (close.xlsm) e sua planilha "INC MARS"
    wb_close = load_workbook(target_file, keep_vba=True)
    ws_inc_mars = wb_close['INC MARS']
   
    # Encontrar a célula que contém "External reference number" na coluna A
    for row in ws_inc_mars.iter_rows(min_row=1, max_row=ws_inc_mars.max_row, min_col=1, max_col=1):
        if row[0].value == "External reference number":
            start_row = row[0].row + 1
            break
   
    # Copiar os valores da coluna "External reference number" para a Tabela1 logo abaixo do cabeçalho
    external_reference_numbers = df_snow['External reference number'].tolist()
    for idx, value in enumerate(external_reference_numbers, start=start_row):
        ws_inc_mars.cell(row=idx, column=1, value=value)
   
    wb_close.save(target_file)
    print(f"Coluna 'External reference number' copiada para 'INC MARS' na Tabela1.")

# Função para deletar a coluna "Number" da Tabela2 e copiar o restante dos dados para Tabela1 na planilha "OBS"
def copy_obs_data_without_number(source_file, target_file):
    # Carregar Tabela2 (obs.xlsx)
    df_obs = pd.read_excel(source_file)
   
    # Deletar a coluna "Number"
    df_obs = df_obs.drop(columns=["Number"])
   
    # Carregar Tabela1 (close.xlsm) e sua planilha "OBS"
    wb_close = load_workbook(target_file, keep_vba=True)
    ws_obs = wb_close['OBS']
   
    # Encontrar a primeira linha vazia na planilha "OBS"
    max_row = ws_obs.max_row + 1
   
    # Copiar os dados restantes da Tabela2 para a planilha "OBS"
    for row in df_obs.itertuples(index=False, name=None):
        ws_obs.append(row)
   
    wb_close.save(target_file)
    print(f"Dados de 'obs.xlsx' (sem a coluna 'Number') copiados para 'OBS' na Tabela1.")

# Arquivos de entrada
close_file = "close.xlsm"
obs_file = "obs.xlsx"
snow_file = "snow.xlsx"

# Executando as funções de automação
copy_external_reference_number(snow_file, close_file)
copy_obs_data_without_number(obs_file, close_file)
